BEGIN TRANSACTION;

/* Eliminar precios de los artículos a depurar */
DELETE GVA17
FROM GVA17
JOIN STA11 ON GVA17.COD_ARTICU = STA11.COD_ARTICU
JOIN STA19 ON STA11.COD_ARTICU = STA19.COD_ARTICU
WHERE STA11.PERFIL = 'N' 
AND STA11.FECHA_ALTA <= '2022-04-30 00:00:00.000' 
AND STA19.CANT_STOCK = '0.0000000' 
AND NOT EXISTS (
    SELECT 1 
    FROM STA20 
    WHERE STA20.COD_ARTICU = STA11.COD_ARTICU 
    AND STA20.FECHA_MOV >= '2022-05-01 00:00:00.000'
)
AND NOT EXISTS (
    SELECT 1 
    FROM GVA53 
    WHERE GVA53.COD_ARTICU = STA11.COD_ARTICU 
    AND GVA53.FECHA_MOV >= '2022-05-01 00:00:00.000'
); --30058

/* Eliminar saldos de los artículos a depurar */
DELETE STA19
FROM STA19
JOIN STA11 ON STA19.COD_ARTICU = STA11.COD_ARTICU
WHERE STA11.PERFIL = 'N' 
AND STA11.FECHA_ALTA <= '2022-04-30 00:00:00.000' 
AND STA19.CANT_STOCK = '0.0000000' 
AND NOT EXISTS (
    SELECT 1 
    FROM STA20 
    WHERE STA20.COD_ARTICU = STA11.COD_ARTICU 
    AND STA20.FECHA_MOV >= '2022-05-01 00:00:00.000'
)
AND NOT EXISTS (
    SELECT 1 
    FROM GVA53 
    WHERE GVA53.COD_ARTICU = STA11.COD_ARTICU 
    AND GVA53.FECHA_MOV >= '2022-05-01 00:00:00.000')
AND NOT EXISTS (
    SELECT 1 
    FROM CPA46 
    WHERE CPA46.COD_ARTICU = STA11.COD_ARTICU 
    AND CPA46.FECHA_MOV >= '2022-05-01 00:00:00.000'
);--158270

/* Eliminar registros de AUXILIAR_REGLA_ARTICULO */
DELETE ARA
FROM AUXILIAR_REGLA_ARTICULO ARA
JOIN APROPIACION_ARTICULO AA ON ARA.ID_APROPIACION_ARTICULO = AA.ID_APROPIACION_ARTICULO
JOIN ARTICULO_CUENTA AC ON AA.ID_ARTICULO_CUENTA = AC.ID_ARTICULO_CUENTA
JOIN STA11 ON AC.COD_STA11 = STA11.COD_STA11
WHERE STA11.PERFIL = 'N' 
AND STA11.FECHA_ALTA <= '2022-04-30 00:00:00.000' 
AND NOT EXISTS (
    SELECT 1 
    FROM STA20 
    WHERE STA20.COD_ARTICU = STA11.COD_ARTICU 
    AND STA20.FECHA_MOV >= '2022-05-01 00:00:00.000'
)
AND NOT EXISTS (
    SELECT 1 
    FROM GVA53 
    WHERE GVA53.COD_ARTICU = STA11.COD_ARTICU 
    AND GVA53.FECHA_MOV >= '2022-05-01 00:00:00.000'
)
AND NOT EXISTS (
    SELECT 1 
    FROM CPA46 
    WHERE CPA46.COD_ARTICU = STA11.COD_ARTICU 
    AND CPA46.FECHA_MOV >= '2022-05-01 00:00:00.000'
); --36

/* Eliminar registros de APROPIACION_ARTICULO */
DELETE AA
FROM APROPIACION_ARTICULO AA
JOIN ARTICULO_CUENTA AC ON AA.ID_ARTICULO_CUENTA = AC.ID_ARTICULO_CUENTA
JOIN STA11 ON AC.COD_STA11 = STA11.COD_STA11
WHERE STA11.PERFIL = 'N' 
AND STA11.FECHA_ALTA <= '2022-04-30 00:00:00.000' 
AND NOT EXISTS (
    SELECT 1 
    FROM STA20 
    WHERE STA20.COD_ARTICU = STA11.COD_ARTICU 
    AND STA20.FECHA_MOV >= '2022-05-01 00:00:00.000'
)
AND NOT EXISTS (
    SELECT 1 
    FROM GVA53 
    WHERE GVA53.COD_ARTICU = STA11.COD_ARTICU 
    AND GVA53.FECHA_MOV >= '2022-05-01 00:00:00.000'
)
AND NOT EXISTS (
    SELECT 1 
    FROM CPA46 
    WHERE CPA46.COD_ARTICU = STA11.COD_ARTICU 
    AND CPA46.FECHA_MOV >= '2022-05-01 00:00:00.000'
); --36


/* Eliminar registros de ARTICULO_CUENTA */
DELETE AC
FROM ARTICULO_CUENTA AC
JOIN STA11 ON AC.COD_STA11 = STA11.COD_STA11
WHERE STA11.PERFIL = 'N' 
AND STA11.FECHA_ALTA <= '2022-04-30 00:00:00.000' 
AND NOT EXISTS (
    SELECT 1 
    FROM STA20 
    WHERE STA20.COD_ARTICU = STA11.COD_ARTICU 
    AND STA20.FECHA_MOV >= '2022-05-01 00:00:00.000'
)
AND NOT EXISTS (
    SELECT 1 
    FROM GVA53 
    WHERE GVA53.COD_ARTICU = STA11.COD_ARTICU 
    AND GVA53.FECHA_MOV >= '2022-05-01 00:00:00.000'
)
AND NOT EXISTS (
    SELECT 1 
    FROM CPA46 
    WHERE CPA46.COD_ARTICU = STA11.COD_ARTICU 
    AND CPA46.FECHA_MOV >= '2022-05-01 00:00:00.000'
); --32243

/* Eliminar registros de CPA46 */
DELETE FROM CPA46
WHERE COD_ARTICU IN (
    SELECT STA11.COD_ARTICU
    FROM STA11 
    WHERE 
        PERFIL = 'N' 
        AND FECHA_ALTA <= '2022-04-30 00:00:00.000'  
); --5938

/* Eliminar registros de GVA53 */
DELETE FROM GVA53
WHERE COD_ARTICU IN (
    SELECT STA11.COD_ARTICU
    FROM STA11 
    WHERE 
        PERFIL = 'N' 
        AND FECHA_ALTA <= '2022-04-30 00:00:00.000' 
);

/* Eliminar registros de STA20 */
DELETE FROM STA20
WHERE COD_ARTICU IN (
    SELECT STA11.COD_ARTICU
    FROM STA11 
    WHERE 
        PERFIL = 'N' 
        AND FECHA_ALTA <= '2022-04-30 00:00:00.000' 
);

/* Eliminar artículos a depurar */
DELETE STA11
FROM STA11
WHERE PERFIL = 'N' 
AND FECHA_ALTA <= '2022-04-30 00:00:00.000' 
AND NOT EXISTS (
    SELECT 1 
    FROM STA20 
    WHERE STA20.COD_ARTICU = STA11.COD_ARTICU 
    AND STA20.FECHA_MOV >= '2022-05-01 00:00:00.000'
)
AND NOT EXISTS (
    SELECT 1 
    FROM GVA53 
    WHERE GVA53.COD_ARTICU = STA11.COD_ARTICU 
    AND GVA53.FECHA_MOV >= '2022-05-01 00:00:00.000')
AND NOT EXISTS (
    SELECT 1 
    FROM CPA46 
    WHERE CPA46.COD_ARTICU = STA11.COD_ARTICU 
    AND CPA46.FECHA_MOV >= '2022-05-01 00:00:00.000')
;

ROLLBACK;
