BEGIN TRANSACTION;

/*Eliminar las FKs anexadas a la STA11*/
ALTER TABLE GVA17 DROP CONSTRAINT FK_GVA17_STA11
ALTER TABLE MAESTRO_GVA17 DROP CONSTRAINT FK_MAESTRO_GVA17_STA11
ALTER TABLE ARTICULO_CUENTA DROP CONSTRAINT FK_ARTICULO_CUENTA_STA11
ALTER TABLE STA_ARTICULO_UNIDAD_COMPRA DROP CONSTRAINT FK_STA_ARTICULO_UNIDAD_COMPRA_STA11
ALTER TABLE CPA15 DROP CONSTRAINT FK_CPA15_STA11
ALTER TABLE STA12 DROP CONSTRAINT FK_STA12_STA11
ALTER TABLE STA19 DROP CONSTRAINT FK_STA19_STA11
ALTER TABLE STA20 DROP CONSTRAINT FK_STA20_STA11
ALTER TABLE CPA46 DROP CONSTRAINT FK_CPA46_STA11
ALTER TABLE STA11ITC DROP CONSTRAINT FK_STA11ITC_STA11


/* Eliminar registros de GVA17 */

DELETE GVA17
FROM GVA17
JOIN STA11 ON GVA17.ID_STA11 = STA11.ID_STA11
JOIN STA19 ON STA11.COD_ARTICU = STA19.COD_ARTICU
WHERE STA11.PERFIL = 'N' 
AND STA11.FECHA_ALTA <= '2022-04-30 00:00:00.000' 
AND STA19.CANT_STOCK = '0.0000000' 
AND NOT EXISTS (
    SELECT 1 
    FROM STA20 
    WHERE STA20.COD_ARTICU = STA11.COD_ARTICU 
    AND STA20.FECHA_MOV >= '2022-05-01 00:00:00.000'
)
AND NOT EXISTS (
    SELECT 1 
    FROM GVA53 
    WHERE GVA53.COD_ARTICU = STA11.COD_ARTICU 
    AND GVA53.FECHA_MOV >= '2022-05-01 00:00:00.000'
)
AND NOT EXISTS (
    SELECT 1 
    FROM CPA46 
    WHERE CPA46.COD_ARTICU = STA11.COD_ARTICU 
    AND CPA46.FECHA_MOV >= '2022-05-01 00:00:00.000') 
AND GVA17.ID_STA11 NOT IN (SELECT ID_STA11 FROM STA11);--30061


/* Eliminar registros de MAESTRO_GVA17 */

DELETE MAESTRO_GVA17
FROM MAESTRO_GVA17
JOIN STA11 ON MAESTRO_GVA17.ID_STA11 = STA11.ID_STA11
JOIN STA19 ON STA11.COD_ARTICU = STA19.COD_ARTICU
JOIN GVA17 ON MAESTRO_GVA17.ID_MAESTRO_GVA17 = GVA17.ID_MAESTRO_GVA17
WHERE STA11.PERFIL = 'N' 
AND STA11.FECHA_ALTA <= '2022-04-30 00:00:00.000' 
AND STA19.CANT_STOCK = '0.0000000' 
AND NOT EXISTS (
    SELECT 1 
    FROM STA20 
    WHERE STA20.COD_ARTICU = STA11.COD_ARTICU 
    AND STA20.FECHA_MOV >= '2022-05-01 00:00:00.000'
)
AND NOT EXISTS (
    SELECT 1 
    FROM GVA53 
    WHERE GVA53.COD_ARTICU = STA11.COD_ARTICU 
    AND GVA53.FECHA_MOV >= '2022-05-01 00:00:00.000'
)
AND NOT EXISTS (
    SELECT 1 
    FROM CPA46 
    WHERE CPA46.COD_ARTICU = STA11.COD_ARTICU 
    AND CPA46.FECHA_MOV >= '2022-05-01 00:00:00.000')


/* Eliminar registros de AUXILIAR_REGLA_ARTICULO */

DELETE ARA
FROM AUXILIAR_REGLA_ARTICULO ARA
JOIN APROPIACION_ARTICULO AA ON ARA.ID_APROPIACION_ARTICULO = AA.ID_APROPIACION_ARTICULO
JOIN ARTICULO_CUENTA AC ON AA.ID_ARTICULO_CUENTA = AC.ID_ARTICULO_CUENTA
JOIN STA11 ON AC.COD_STA11 = STA11.COD_STA11
JOIN STA19 ON STA11.COD_ARTICU = STA19.COD_ARTICU
WHERE STA11.PERFIL = 'N' 
AND STA11.FECHA_ALTA <= '2022-04-30 00:00:00.000' 
AND STA19.CANT_STOCK = '0.0000000' 
AND NOT EXISTS (
    SELECT 1 
    FROM STA20 
    WHERE STA20.COD_ARTICU = STA11.COD_ARTICU 
    AND STA20.FECHA_MOV >= '2022-05-01 00:00:00.000'
)
AND NOT EXISTS (
    SELECT 1 
    FROM GVA53 
    WHERE GVA53.COD_ARTICU = STA11.COD_ARTICU 
    AND GVA53.FECHA_MOV >= '2022-05-01 00:00:00.000'
)
AND NOT EXISTS (
    SELECT 1 
    FROM CPA46 
    WHERE CPA46.COD_ARTICU = STA11.COD_ARTICU 
    AND CPA46.FECHA_MOV >= '2022-05-01 00:00:00.000'
); --13

/* Eliminar registros de APROPIACION_ARTICULO */

DELETE AA
FROM APROPIACION_ARTICULO AA
JOIN ARTICULO_CUENTA AC ON AA.ID_ARTICULO_CUENTA = AC.ID_ARTICULO_CUENTA
JOIN STA11 ON AC.COD_STA11 = STA11.COD_STA11
JOIN STA19 ON STA11.COD_ARTICU = STA19.COD_ARTICU
WHERE STA11.PERFIL = 'N' 
AND STA11.FECHA_ALTA <= '2022-04-30 00:00:00.000' 
AND STA19.CANT_STOCK = '0.0000000' 
AND NOT EXISTS (
    SELECT 1 
    FROM STA20 
    WHERE STA20.COD_ARTICU = STA11.COD_ARTICU 
    AND STA20.FECHA_MOV >= '2022-05-01 00:00:00.000'
)
AND NOT EXISTS (
    SELECT 1 
    FROM GVA53 
    WHERE GVA53.COD_ARTICU = STA11.COD_ARTICU 
    AND GVA53.FECHA_MOV >= '2022-05-01 00:00:00.000'
)
AND NOT EXISTS (
    SELECT 1 
    FROM CPA46 
    WHERE CPA46.COD_ARTICU = STA11.COD_ARTICU 
    AND CPA46.FECHA_MOV >= '2022-05-01 00:00:00.000'
); --13


/* Eliminar registros de ARTICULO_CUENTA */

DELETE AC
FROM ARTICULO_CUENTA AC
JOIN STA11 ON AC.COD_STA11 = STA11.COD_STA11
JOIN STA19 ON STA11.COD_ARTICU = STA19.COD_ARTICU
WHERE STA11.PERFIL = 'N' 
AND STA11.FECHA_ALTA <= '2022-04-30 00:00:00.000' 
AND STA19.CANT_STOCK = '0.0000000' 
AND NOT EXISTS (
    SELECT 1 
    FROM STA20 
    WHERE STA20.COD_ARTICU = STA11.COD_ARTICU 
    AND STA20.FECHA_MOV >= '2022-05-01 00:00:00.000'
)
AND NOT EXISTS (
    SELECT 1 
    FROM GVA53 
    WHERE GVA53.COD_ARTICU = STA11.COD_ARTICU 
    AND GVA53.FECHA_MOV >= '2022-05-01 00:00:00.000'
)
AND NOT EXISTS (
    SELECT 1 
    FROM CPA46 
    WHERE CPA46.COD_ARTICU = STA11.COD_ARTICU 
    AND CPA46.FECHA_MOV >= '2022-05-01 00:00:00.000'
); --29225


/*Eliminar registros STA_ARTICULO_UNIDAD_COMPRA*/

SET DATEFORMAT YMD
DELETE FROM STA_ARTICULO_UNIDAD_COMPRA
WHERE ID_STA11 IN (
    SELECT STA.ID_STA11
    FROM STA_ARTICULO_UNIDAD_COMPRA STA
    JOIN STA11 ON STA.ID_STA11 = STA11.ID_STA11
	JOIN STA19 ON STA11.COD_ARTICU = STA19.COD_ARTICU
    WHERE STA11.PERFIL = 'N' 
    AND STA11.FECHA_ALTA <= '2022-04-30 00:00:00.000' 
	AND STA19.CANT_STOCK = '0.0000000' 
    AND NOT EXISTS (
        SELECT 1 
        FROM STA20 
        WHERE STA20.COD_ARTICU = STA11.COD_ARTICU 
        AND STA20.FECHA_MOV >= '2022-05-01 00:00:00.000'
    )
    AND NOT EXISTS (
        SELECT 1 
        FROM GVA53 
        WHERE GVA53.COD_ARTICU = STA11.COD_ARTICU 
        AND GVA53.FECHA_MOV >= '2022-05-01 00:00:00.000'
    )
    AND NOT EXISTS (
        SELECT 1 
        FROM CPA46 
        WHERE CPA46.COD_ARTICU = STA11.COD_ARTICU 
        AND CPA46.FECHA_MOV >= '2022-05-01 00:00:00.000'
    )
);--29242

/*Eliminar registros de la STA12 */

DELETE STA12 from STA12 
join STA11 on STA12.COD_ARTICU = STA11.COD_ARTICU
JOIN STA19 ON STA11.COD_ARTICU = STA19.COD_ARTICU
WHERE STA11.PERFIL = 'N' 
AND STA19.CANT_STOCK = '0.0000000' 
AND STA11.FECHA_ALTA <= '2022-04-30 00:00:00.000' 
AND NOT EXISTS (
    SELECT 1 
    FROM STA20 
    WHERE STA20.COD_ARTICU = STA11.COD_ARTICU 
    AND STA20.FECHA_MOV >= '2022-05-01 00:00:00.000'
)
AND NOT EXISTS (
    SELECT 1 
    FROM GVA53 
    WHERE GVA53.COD_ARTICU = STA11.COD_ARTICU 
    AND GVA53.FECHA_MOV >= '2022-05-01 00:00:00.000')
AND NOT EXISTS (
    SELECT 1 
    FROM CPA46 
    WHERE CPA46.COD_ARTICU = STA11.COD_ARTICU 
    AND CPA46.FECHA_MOV >= '2022-05-01 00:00:00.000')
--29104


/* Eliminar STA83 */

delete STA83 from Sta83
JOIN STA11 ON STA83.id_sta11 = STA11.id_sta11
WHERE STA11.PERFIL = 'N' 
AND STA11.FECHA_ALTA <= '2022-04-30 00:00:00.000' 
AND NOT EXISTS (
    SELECT 1 
    FROM STA20 
    WHERE STA20.COD_ARTICU = STA11.COD_ARTICU 
    AND STA20.FECHA_MOV >= '2022-05-01 00:00:00.000'
)
AND NOT EXISTS (
    SELECT 1 
    FROM GVA53 
    WHERE GVA53.COD_ARTICU = STA11.COD_ARTICU 
    AND GVA53.FECHA_MOV >= '2022-05-01 00:00:00.000')
AND NOT EXISTS (
    SELECT 1 
    FROM CPA46 
    WHERE CPA46.COD_ARTICU = STA11.COD_ARTICU 
    AND CPA46.FECHA_MOV >= '2022-05-01 00:00:00.000')


/* Eliminar STA03 */

DELETE STA03 from STA03 
JOIN STA11 ON STA03.ID_STA11 = STA11.ID_STA11
WHERE STA11.PERFIL = 'N' 
AND STA11.FECHA_ALTA <= '2022-04-30 00:00:00.000' 
AND NOT EXISTS (
    SELECT 1 
    FROM STA20 
    WHERE STA20.COD_ARTICU = STA11.COD_ARTICU 
    AND STA20.FECHA_MOV >= '2022-05-01 00:00:00.000'
)
AND NOT EXISTS (
    SELECT 1 
    FROM GVA53 
    WHERE GVA53.COD_ARTICU = STA11.COD_ARTICU 
    AND GVA53.FECHA_MOV >= '2022-05-01 00:00:00.000')
AND NOT EXISTS (
    SELECT 1 
    FROM CPA46 
    WHERE CPA46.COD_ARTICU = STA11.COD_ARTICU 
    AND CPA46.FECHA_MOV >= '2022-05-01 00:00:00.000')


/* Eliminar STA_ARTICULO_FOTO */
Delete STA_ARTICULO_FOTO from STA_ARTICULO_FOTO
JOIN STA11 ON STA_ARTICULO_FOTO.ID_STA11 = STA11.ID_STA11
WHERE STA11.PERFIL = 'N' 
AND STA11.FECHA_ALTA <= '2022-04-30 00:00:00.000' 
AND NOT EXISTS (
    SELECT 1 
    FROM STA20 
    WHERE STA20.COD_ARTICU = STA11.COD_ARTICU 
    AND STA20.FECHA_MOV >= '2022-05-01 00:00:00.000'
)
AND NOT EXISTS (
    SELECT 1 
    FROM GVA53 
    WHERE GVA53.COD_ARTICU = STA11.COD_ARTICU 
    AND GVA53.FECHA_MOV >= '2022-05-01 00:00:00.000')
AND NOT EXISTS (
    SELECT 1 
    FROM CPA46 
    WHERE CPA46.COD_ARTICU = STA11.COD_ARTICU 
    AND CPA46.FECHA_MOV >= '2022-05-01 00:00:00.000')

/* Eliminar registros de CPA15 */

DELETE CPA15 from CPA15 
join STA11 on STA11.COD_ARTICU = CPA15.COD_ARTICU
JOIN STA19 ON STA11.COD_ARTICU = STA19.COD_ARTICU
WHERE STA11.PERFIL = 'N' 
AND STA11.FECHA_ALTA <= '2022-04-30 00:00:00.000' 
AND STA19.CANT_STOCK = '0.0000000'
AND NOT EXISTS (
    SELECT 1 
    FROM STA20 
    WHERE STA20.COD_ARTICU = STA11.COD_ARTICU 
    AND STA20.FECHA_MOV >= '2022-05-01 00:00:00.000'
)
AND NOT EXISTS (
    SELECT 1 
    FROM GVA53 
    WHERE GVA53.COD_ARTICU = STA11.COD_ARTICU 
    AND GVA53.FECHA_MOV >= '2022-05-01 00:00:00.000')
AND NOT EXISTS (
    SELECT 1 
    FROM CPA46 
    WHERE CPA46.COD_ARTICU = STA11.COD_ARTICU 
    AND CPA46.FECHA_MOV >= '2022-05-01 00:00:00.000')
--19559

/* Eliminar STA11ITC */

DELETE STA11ITC
FROM STA11ITC
JOIN STA11 ON STA11ITC.ID_STA11 = STA11.ID_STA11
JOIN STA19 ON STA11.COD_ARTICU = STA19.COD_ARTICU
WHERE STA11.PERFIL = 'N' 
AND STA11.FECHA_ALTA <= '2022-04-30 00:00:00.000' 
AND STA19.CANT_STOCK = '0.0000000'
AND NOT EXISTS (
    SELECT 1 
    FROM STA20 
    WHERE STA20.COD_ARTICU = STA11.COD_ARTICU 
    AND STA20.FECHA_MOV >= '2022-05-01 00:00:00.000'
)
AND NOT EXISTS (
    SELECT 1 
    FROM GVA53 
    WHERE GVA53.COD_ARTICU = STA11.COD_ARTICU 
    AND GVA53.FECHA_MOV >= '2022-05-01 00:00:00.000')
AND NOT EXISTS (
    SELECT 1 
    FROM CPA46 
    WHERE CPA46.COD_ARTICU = STA11.COD_ARTICU 
    AND CPA46.FECHA_MOV >= '2022-05-01 00:00:00.000')
;--171345


/* Eliminar registros de CPA46 */

DELETE FROM CPA46
WHERE COD_ARTICU IN (
    SELECT STA11.COD_ARTICU
    FROM STA11 
	JOIN STA19 ON STA11.COD_ARTICU = STA19.COD_ARTICU
    WHERE 
        PERFIL = 'N' 
        AND FECHA_ALTA <= '2022-04-30 00:00:00.000'  
		AND STA19.CANT_STOCK = '0.0000000'
		AND CPA46.FECHA_MOV >= '2022-05-01 00:00:00.000'
); --32278

/* Eliminar registros de GVA53 */

DELETE FROM GVA53
WHERE COD_ARTICU IN (
    SELECT STA11.COD_ARTICU
    FROM STA11 
	JOIN STA19 ON STA11.COD_ARTICU = STA19.COD_ARTICU
    WHERE 
        PERFIL = 'N' 
        AND FECHA_ALTA <= '2022-04-30 00:00:00.000' 
		AND STA19.CANT_STOCK = '0.0000000'
		AND GVA53.FECHA_MOV >= '2022-05-01 00:00:00.000'
);--10131

/* Eliminar registros de STA20 */

DELETE FROM STA20
WHERE COD_ARTICU IN (
    SELECT STA11.COD_ARTICU
    FROM STA11 
	JOIN STA19 ON STA11.COD_ARTICU = STA19.COD_ARTICU
    WHERE 
        PERFIL = 'N' 
        AND FECHA_ALTA <= '2022-04-30 00:00:00.000' 
		AND STA19.CANT_STOCK = '0.0000000'
		AND STA20.FECHA_MOV >= '2022-05-01 00:00:00.000'
);--39509



/* Eliminar STA19 a depurar */

DELETE STA19
FROM STA19
JOIN STA11 ON STA19.COD_ARTICU = STA11.COD_ARTICU
WHERE STA11.PERFIL = 'N' 
AND STA11.FECHA_ALTA <= '2022-04-30 00:00:00.000' 
AND STA19.CANT_STOCK = '0.0000000'
AND NOT EXISTS (
    SELECT 1 
    FROM STA20 
    WHERE STA20.COD_ARTICU = STA11.COD_ARTICU 
    AND STA20.FECHA_MOV >= '2022-05-01 00:00:00.000'
)
AND NOT EXISTS (
    SELECT 1 
    FROM GVA53 
    WHERE GVA53.COD_ARTICU = STA11.COD_ARTICU 
    AND GVA53.FECHA_MOV >= '2022-05-01 00:00:00.000')
AND NOT EXISTS (
    SELECT 1 
    FROM CPA46 
    WHERE CPA46.COD_ARTICU = STA11.COD_ARTICU 
    AND CPA46.FECHA_MOV >= '2022-05-01 00:00:00.000')
;--171345


/* Eliminar STA11 a depurar */
DELETE STA11 FROM STA11 
WHERE STA11.PERFIL = 'N' 
AND FECHA_ALTA <= '2022-04-30 00:00:00.000'
AND NOT EXISTS (
        SELECT 1 
        FROM STA20 
        WHERE STA20.COD_ARTICU = STA11.COD_ARTICU 
        AND STA20.FECHA_MOV >= '2022-05-01 00:00:00.000'
        )
        AND NOT EXISTS (
        SELECT 1 
        FROM GVA53 
        WHERE GVA53.COD_ARTICU = STA11.COD_ARTICU 
        AND GVA53.FECHA_MOV >= '2022-05-01 00:00:00.000'
        )
        AND NOT EXISTS (
        SELECT 1 
        FROM CPA46 
        WHERE CPA46.COD_ARTICU = STA11.COD_ARTICU 
        AND CPA46.FECHA_MOV >= '2022-05-01 00:00:00.000'
        )
		AND NOT EXISTS (
        SELECT 1 
        FROM STA19 
        WHERE STA19.COD_ARTICU = STA11.COD_ARTICU 
       ); --32556




--Crear FK [GVA17]
ALTER TABLE [dbo].[GVA17]  WITH CHECK ADD  CONSTRAINT [FK_GVA17_STA11] FOREIGN KEY([ID_STA11])
REFERENCES [dbo].[STA11] ([ID_STA11])
GO
ALTER TABLE [dbo].[GVA17] CHECK CONSTRAINT [FK_GVA17_STA11]
GO

--Crear FK [MAESTRO_GVA17]
ALTER TABLE [dbo].[MAESTRO_GVA17]  WITH CHECK ADD  CONSTRAINT [FK_MAESTRO_GVA17_STA11] FOREIGN KEY([ID_STA11])
REFERENCES [dbo].[STA11] ([ID_STA11])
GO
ALTER TABLE [dbo].[MAESTRO_GVA17] CHECK CONSTRAINT [FK_MAESTRO_GVA17_STA11]
GO

--Crear FK [ARTICULO_CUENTA]
ALTER TABLE [dbo].[ARTICULO_CUENTA]  WITH CHECK ADD  CONSTRAINT [FK_ARTICULO_CUENTA_STA11] FOREIGN KEY([ID_STA11])
REFERENCES [dbo].[STA11] ([ID_STA11])
GO
ALTER TABLE [dbo].[ARTICULO_CUENTA] CHECK CONSTRAINT [FK_ARTICULO_CUENTA_STA11]
GO


--Crear FK [STA_ARTICULO_UNIDAD_COMPRA]
ALTER TABLE [dbo].[STA_ARTICULO_UNIDAD_COMPRA]  WITH CHECK ADD  CONSTRAINT [FK_STA_ARTICULO_UNIDAD_COMPRA_STA11] FOREIGN KEY([ID_STA11])
REFERENCES [dbo].[STA11] ([ID_STA11])
GO
ALTER TABLE [dbo].[STA_ARTICULO_UNIDAD_COMPRA] CHECK CONSTRAINT [FK_STA_ARTICULO_UNIDAD_COMPRA_STA11]
GO


--Crear FK [CPA15]
ALTER TABLE [dbo].[CPA15]  WITH CHECK ADD  CONSTRAINT [FK_CPA15_STA11] FOREIGN KEY([ID_STA11])
REFERENCES [dbo].[STA11] ([ID_STA11])
GO
ALTER TABLE [dbo].[CPA15] CHECK CONSTRAINT [FK_CPA15_STA11]
GO

--Crear FK [STA12]
ALTER TABLE [dbo].[STA12]  WITH CHECK ADD  CONSTRAINT [FK_STA12_STA11] FOREIGN KEY([ID_STA11])
REFERENCES [dbo].[STA11] ([ID_STA11])
GO
ALTER TABLE [dbo].[STA12] CHECK CONSTRAINT [FK_STA12_STA11]
GO


--Crear FK [STA19]
ALTER TABLE [dbo].[STA19]  WITH CHECK ADD  CONSTRAINT [FK_STA19_STA11] FOREIGN KEY([ID_STA11])
REFERENCES [dbo].[STA11] ([ID_STA11])
GO
ALTER TABLE [dbo].[STA19] CHECK CONSTRAINT [FK_STA19_STA11]
GO

--Crear FK [STA20]
ALTER TABLE [dbo].[sta20]  WITH CHECK ADD  CONSTRAINT [FK_STA20_STA11] FOREIGN KEY([ID_STA11])
REFERENCES [dbo].[STA11] ([ID_STA11])
GO
ALTER TABLE [dbo].[sta20] CHECK CONSTRAINT [FK_STA20_STA11]
GO



--Crear FK [CPA46]
ALTER TABLE [dbo].[CPA46]  WITH CHECK ADD  CONSTRAINT [FK_CPA46_STA11] FOREIGN KEY([ID_STA11])
REFERENCES [dbo].[STA11] ([ID_STA11])
GO
ALTER TABLE [dbo].[CPA46] CHECK CONSTRAINT [FK_CPA46_STA11]
GO


--Crear FK [STA11ITC]
ALTER TABLE [dbo].[STA11ITC]  WITH CHECK ADD  CONSTRAINT [FK_STA11ITC_STA11] FOREIGN KEY([ID_STA11])
REFERENCES [dbo].[STA11] ([ID_STA11])
GO
ALTER TABLE [dbo].[STA11ITC] CHECK CONSTRAINT [FK_STA11ITC_STA11]
GO




ROLLBACK;



