SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
SET DATEFORMAT DMY 
SET DATEFIRST 7 
SET DEADLOCK_PRIORITY -8;

SELECT 
    GVA14.CAMPOS_ADICIONALES.value('(/CAMPOS_ADICIONALES/CA_PRIORIDAD)[1]', 'nvarchar(max)') AS [Prioridad], --Campo Adicional en el Cliente
    GVA21.NRO_PEDIDO AS [Nro. NCM] , --Numero del Pedido
	GVA21.NRO_OC_COMP AS [Incidencia] , --Numero de la Orden de Compra del Pedido
	GVA14.CAMPOS_ADICIONALES.value('(/CAMPOS_ADICIONALES/CA_NMERO_ALTERNATIVO)[1]', 'nvarchar(max)') AS [N° Alternativo], --Campo Adicional en el Cliente
	GVA24.NOMBRE_TRA AS [Tecnico] , --Transporte
	GVA14.CAMPOS_ADICIONALES.value('(/CAMPOS_ADICIONALES/CA_TEXT_1694021766163)[1]', 'nvarchar(max)') AS [Solicita], --Campo Adicional en el Cliente
    CASE WHEN GVA21.FECHA_PEDI = '01/01/1800' THEN NULL ELSE GVA21.FECHA_PEDI END AS [Fecha Carga] , --Fecha Pedido
    CASE WHEN GVA21.FECHA_ENTR <> '01/01/1800' THEN GVA21.FECHA_ENTR  ELSE CASE WHEN TEMP.FECHA_MINIMA <> '01/01/1800' THEN TEMP.FECHA_MINIMA ELSE NULL END END AS [Fecha Realizacion/Vencimiento] , --Fecha Entrega
    CASE GVA21.ESTADO WHEN 1 THEN 'INGRESADO' WHEN 2 THEN  'APROBADO' WHEN 3 THEN 'CUMPLIDO' WHEN 4 THEN 'CERRADO' WHEN 5 THEN 'ANULADO' WHEN 6 THEN 'REVISADO'	WHEN 7 THEN 'DESAPROBADO' ELSE '' END AS [Estado] ,
    --GVA03.COD_ARTICU AS [Cód. Artículo] ,
    GVA21.LEYENDA_2 AS [Observaciones] , --Leyenda 2
    GVA21.LEYENDA_3 AS [Observaciones] , --Leyenda 3
    GVA21.LEYENDA_4 AS [Observaciones] , --Leyenda 4
    GVA21.LEYENDA_5 AS [Observaciones] , --Leyenda 5
	GVA21.LEYENDA_1 AS [Motivo] ,  --Leyenda 1
	ISNULL(GVA45.[DESC], STA11.DESCRIPCIO) AS [Descripción] ,
    ISNULL(GVA45.DESC_ADIC, STA11.DESC_ADIC) AS [Desc. Adicional] ,
    ISNULL(GVA45.DESC_ADIC, STA11.DESC_ADIC) AS [Desc. Adicional] 
FROM
    GVA03 (NOLOCK)  JOIN GVA21 ON GVA03.NRO_PEDIDO =GVA21.NRO_PEDIDO and GVA03.TALON_PED=GVA21.TALON_PED  
    LEFT JOIN GVA16 ON 1=1 
    LEFT JOIN GVA10 ON GVA10.NRO_DE_LIS = GVA21.N_Lista  
    LEFT JOIN (SELECT TALON_PED, NRO_PEDIDO, MIN(FEC_ENTREG) AS FECHA_MINIMA FROM GVA126 GROUP BY TALON_PED, NRO_PEDIDO ) AS TEMP ON GVA21.TALON_PED = TEMP.TALON_PED AND GVA21.NRO_PEDIDO = TEMP.NRO_PEDIDO 
    LEFT JOIN (SELECT GVA21.TALON_PED, GVA21.NRO_PEDIDO, SUM (((CASE GVA10.MON_CTE WHEN 1 THEN GVA03.PRECIO ELSE (GVA03.PRECIO * GVA21.Cotiz) END ) * (1 - (GVA03.DESCUENTO) / 100)) * (GVA03.Cant_Pen_F)) TOTAL_SIN_DESCUENTO FROM GVA21 INNER JOIN GVA10 ON GVA21.N_Lista = GVA10.Nro_de_Lis INNER  JOIN GVA03 ON (GVA21.TALON_PED = GVA03.TALON_PED AND  GVA21.NRO_PEDIDO = GVA03.NRO_PEDIDO) GROUP BY GVA21.TALON_PED, GVA21.NRO_PEDIDO) AS TEMP2 ON GVA21.TALON_PED = TEMP2.TALON_PED AND GVA21.NRO_PEDIDO = TEMP2.NRO_PEDIDO  
    LEFT JOIN EMPRESA ON 1 = 1  
    LEFT JOIN SUCURSAL ON ((ISNULL(GVA21.NRO_SUCURS, 0) = 0 AND SUCURSAL.ID_SUCURSAL = EMPRESA.ID_SUCURSAL) OR GVA21.NRO_SUCURS = SUCURSAL.NRO_SUCURSAL)  
    LEFT JOIN SUCURSAL SUCURSAL_DESTINO ON GVA21.NRO_SUCURSAL_DESTINO_PEDIDO = SUCURSAL_DESTINO.NRO_SUCURSAL 
    LEFT JOIN GVA43 (NOLOCK) ON GVA21.TALON_PED = GVA43.TALONARIO
    LEFT JOIN GVA24 (NOLOCK) ON GVA21.COD_TRANSP = GVA24.COD_TRANSP
    LEFT JOIN STA16 ON 1=1
    FULL OUTER JOIN STA11 (NOLOCK) ON GVA03.COD_ARTICU = STA11.COD_ARTICU
    LEFT JOIN GVA45 (NOLOCK) ON GVA45.TALONARIO = GVA03.TALON_PED AND GVA45.N_COMP = GVA03.NRO_PEDIDO AND GVA45.N_RENGLON = GVA03.N_RENGLON
    LEFT JOIN DIRECCION_ENTREGA ON DIRECCION_ENTREGA.ID_DIRECCION_ENTREGA = GVA21.ID_DIRECCION_ENTREGA
    LEFT JOIN GVA14 ON GVA14.COD_CLIENT = GVA21.COD_CLIENT

WHERE 

    GVA03.COD_ARTICU <> ''
   -- AND 
   -- ( (GVA21.FECHA_PEDI BETWEEN '01/09/2023' AND '30/09/2023')) AND GVA03.RENGL_PADR = 0
    AND (GVA14.CAMPOS_ADICIONALES IS NULL OR GVA14.CAMPOS_ADICIONALES.exist('/CAMPOS_ADICIONALES/CA_PRIORIDAD') = 1)



