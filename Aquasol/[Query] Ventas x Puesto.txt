--Ejecución de la vista en Tango.
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
SET DATEFORMAT DMY 
SET DATEFIRST 7 
SET DEADLOCK_PRIORITY -8;
Select * from VentasXPuesto


--Creación de la vista.
Create View VentasXPuesto AS (
SELECT 
	GVA12.FECHA_EMIS AS [Fecha emisión] ,
	(COUNT(*)) AS [Cantidad de facturas] ,
	GVA12.T_COMP AS [Tipo comprobante] ,
	GVA12.N_COMP AS [Nro. comprobante] ,
	SUM(dbo.SUMGVA12IMPORTES('BIMONCTE', GVA12.COTIZ, 1, CASE GVA14.CLAUSULA WHEN 1 THEN 'S' ELSE 'N' END, 'N', GVA15.TIPO_COMP, CASE GVA12.MON_CTE WHEN 1 THEN 'S' ELSE 'N' END, GVA12.IMPORTE_IV,IMPUESTOS.IMPORTE, 2,GVA12.IMPORTE)) + SUM(dbo.SUMGVA12IMPORTES('BIMONCTE', GVA12.COTIZ, 1, CASE GVA14.CLAUSULA WHEN 1 THEN 'S' ELSE 'N' END, 'N', GVA15.TIPO_COMP, CASE GVA12.MON_CTE WHEN 1 THEN 'S' ELSE 'N' END, (-1) * GVA12.IMPORTE_IV, (-1) * IMPUESTOS.IMPORTE, 2,0))  AS [Total c/impuestos] ,
	CASE GVA12.USUARIO_INGRESO
        WHEN 'BOLETERIA1' THEN 'BOLETERIA 1'
        WHEN 'BOLETERIA2' THEN 'BOLETERIA 2'
        WHEN 'BOLETERIA3' THEN 'BOLETERIA 3'
        WHEN 'BOLETERIA4' THEN 'BOLETERIA 4'
        WHEN 'BOLETERIA5' THEN 'BOLETERIA 5'
        WHEN 'LOCKERS' THEN 'LOCKERS'
        WHEN 'PUESTO1' THEN 'PUESTO 1'
        WHEN 'PUESTO2' THEN 'PUESTO 2'
        WHEN 'PUESTO3' THEN 'PUESTO 3'
        WHEN 'PUESTO4' THEN 'PUESTO 4'
        WHEN 'PUESTO5' THEN 'PUESTO 5'
        WHEN 'VALIDACION1' THEN 'VALIDACION 1'
        WHEN 'VALIDACION2' THEN 'VALIDACION 2'
        WHEN 'VALIDACION3' THEN 'VALIDACION 3'
        WHEN 'FLOTADORES' THEN 'FLOTADORES'
		WHEN 'VISITANTES1' THEN 'ATENCION VISITANTES'
        ELSE GVA12.USUARIO_INGRESO
    END AS [Usuario],
		CASE GVA12.TERMINAL_INGRESO
        WHEN 'PC-BOLETERIA01' THEN 'PC BOLETERIA 1'
        WHEN 'PC-BOLETERIA02' THEN 'PC BOLETERIA 2'
        WHEN 'PC-BOLETERIA03' THEN 'PC BOLETERIA 3'
        WHEN 'PC-BOLETERIA04' THEN 'PC BOLETERIA 4'
        WHEN 'PC-BOLETERIA05' THEN 'PC BOLETERIA 5'
        WHEN 'PC-LOCKERS' THEN 'PC LOCKERS'
        WHEN 'PUESTO01-VERDE' THEN 'PUESTO 1 VERDE'
        WHEN 'PUESTO02-AMARIL' THEN 'PUESTO 2 AMARILLO'
        WHEN 'PUESTO03-NEGRO' THEN 'PUESTO 3 NEGRO'
        WHEN 'PUESTO04-AZUL' THEN 'PUESTO 4 AZUL'
        WHEN 'PUESTO05-MARRON' THEN 'PUESTO 5 MARRON'
        WHEN 'PC-VALIDACION01' THEN 'PC VALIDACION 1'
        WHEN 'PC-VALIDACION02' THEN 'PC VALIDACION 2'
        WHEN 'PC-VALIDACION03' THEN 'PC VALIDACION 3'
        WHEN 'PC-FLOTADORES' THEN 'PC FLOTADORES'
		WHEN 'PC-ATENCION01' THEN 'PC ATENCION VISITANTES'
        ELSE GVA12.TERMINAL_INGRESO
    END AS [Puesto]
FROM 
 GVA12  
LEFT JOIN GVA15 ON (GVA15.IDENT_COMP = GVA12.T_COMP)  
LEFT JOIN GVA14 ON (GVA12.COD_CLIENT = GVA14.COD_CLIENT)  
LEFT JOIN GVA23 ON (GVA12.COD_VENDED = GVA23.COD_VENDED)  
LEFT JOIN DIRECCION_ENTREGA ON DIRECCION_ENTREGA.ID_DIRECCION_ENTREGA = GVA12.ID_DIRECCION_ENTREGA  
LEFT JOIN (SELECT * FROM OPERACIÓN_AFIP WHERE OPERACIÓN_AFIP.MODULO = 'V') AS OPERACIÓN_AFIP ON OPERACIÓN_AFIP.COD_OPERACION_AFIP = GVA12.RG_3685_TIPO_OPERACION_VENTAS  
LEFT JOIN GVA12_FCE ON GVA12_FCE.T_COMP = GVA12.T_COMP AND GVA12_FCE.N_COMP = GVA12.N_COMP  
LEFT JOIN ESTADO_COMPROBANTE_FCE ON ESTADO_COMPROBANTE_FCE.ID_ESTADO_COMPROBANTE_FCE = GVA12_FCE.ID_ESTADO_COMPROBANTE_FCE  
LEFT JOIN (SELECT T_COMP,N_COMP,SUM(GVA42.IMPORTE) AS IMPORTE FROM GVA42 WHERE T_COMP <> 'REC' AND ((COD_ALICUO BETWEEN 21 AND 80 OR COD_ALICUO = 82) OR COD_IMPUES <> '')  GROUP BY T_COMP ,N_COMP)IMPUESTOS ON (GVA12.T_COMP = IMPUESTOS.T_COMP AND GVA12.N_COMP = IMPUESTOS.N_COMP)  
LEFT JOIN gva24  ON GVA24.COD_GVA24 COLLATE Latin1_General_BIN = GVA12.COD_TRANSP   
LEFT JOIN GVA05 on GVA05.COD_GVA05 = GVA14.COD_GVA05   
LEFT JOIN GVA81 ON GVA81.COD_CLASIF = GVA12.COD_CLASIF   
LEFT JOIN GVA38 ON GVA12.COD_CLIENT = '000000' AND GVA38.T_COMP = GVA12.T_COMP AND GVA38.N_COMP = GVA12.N_COMP  
LEFT JOIN GVA18 ON (GVA12.COD_CLIENT <> '000000' AND GVA14.COD_PROVIN = GVA18.COD_PROVIN) OR (GVA12.COD_CLIENT = '000000' AND GVA38.COD_PROVIN = GVA18.COD_PROVIN)  
LEFT JOIN GVA133 ON GVA18.COD_PAIS = GVA133.COD_PAIS 	
LEFT JOIN (SELECT NEXO_PEDIDOS_RELACION_FACTURA.T_COMP, NEXO_PEDIDOS_RELACION_FACTURA.N_COMP,	MAX(NEXO_PEDIDOS_ORDEN.EMAIL_COMPRADOR) AS EmailComprador,	CASE MAX(NEXO_PEDIDOS_RELACION_FACTURA.ID_TIENDA)  WHEN 1 THEN 'MercadoLibre Argentina'   WHEN 3 THEN 'Tienda Nube Argentina'   WHEN 7 THEN 'API'    WHEN 8 THEN 'Shopee Argentina'    ELSE ISNULL(CASE WHEN MAX(GVA21.TIENDA) = NULL  THEN NULL ELSE MAX(GVA21.TIENDA) END, 'Presencial')  END AS Origen,	ISNULL(MAX(NEXO_PEDIDOS_ORDEN.TIENDA_QUE_VENDE), ISNULL(MAX(GVA21.TIENDA_QUE_VENDE),'')) AS TIENDAQUEVENDE,	ISNULL(MAX(NEXO_PEDIDOS_ORDEN.USUARIO_TIENDA_VENDEDOR), ISNULL(MAX(GVA21.USUARIO_TIENDA_VENDEDOR),'')) AS CUENTA	FROM NEXO_PEDIDOS_RELACION_FACTURA	
LEFT JOIN NEXO_PEDIDOS_ORDEN ON NEXO_PEDIDOS_RELACION_FACTURA.ID_NEXO_PEDIDOS_ORDEN = NEXO_PEDIDOS_ORDEN.ID_NEXO_PEDIDOS_ORDEN	
LEFT JOIN GVA21 ON NEXO_PEDIDOS_RELACION_FACTURA.TALONARIO_PEDIDO = GVA21.TALON_PED AND NEXO_PEDIDOS_RELACION_FACTURA.NUMERO_PEDIDO = GVA21.NRO_PEDIDO	GROUP BY NEXO_PEDIDOS_RELACION_FACTURA.T_COMP, NEXO_PEDIDOS_RELACION_FACTURA.N_COMP) AS FACTURA_ORIGEN ON GVA12.T_COMP = FACTURA_ORIGEN.T_COMP AND GVA12.N_COMP = FACTURA_ORIGEN.N_COMP


WHERE 

GVA12.NRO_SUCURS = 0 AND GVA12.ESTADO <> 'ANU' AND GVA12.T_COMP <> 'REC'
AND GVA12.COD_VENDED <> '**' AND ISNULL(FACTURA_ORIGEN.Origen, 'Presencial') IN ( 'Presencial' ) 

GROUP BY 
	GVA12.FECHA_EMIS , GVA12.T_COMP , GVA12.N_COMP , GVA12.USUARIO_INGRESO, GVA12.TERMINAL_INGRESO
)

